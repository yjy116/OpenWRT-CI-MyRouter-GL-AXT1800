name: Auto-Build

on:
  # æ¯å¤© 00:00ï¼ˆæ–°åŠ å¡/åŒ—äº¬æ—¶é—´ï¼ŒUTC+8ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  schedule:
    - cron: "0 16 * * *"
  # ä»æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions: write-all

jobs:
  # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ä¸Šæ¸¸æºç æ˜¯å¦æœ‰æ›´æ–°
  check_updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Check upstream updates (last 24h)
        id: check
        env:
          # ğŸ”§ ä¿®æ”¹æˆ AXT1800.yml ä¸­çš„ SOURCE å’Œ BRANCH
          SOURCE: VIKINGYFY/immortalwrt
          BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking commits for $SOURCE on branch $BRANCH in the last 24 hours..."

          # è®¡ç®— 24 å°æ—¶å‰çš„ UTC æ—¶é—´
          since=$(date -u -d '24 hours ago' +'%Y-%m-%dT%H:%M:%SZ')
          echo "Since: $since"

          # æŸ¥è¯¢ä¸Šæ¸¸ä»“åº“è¿‡å» 24 å°æ—¶æ˜¯å¦æœ‰æäº¤
          resp=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$SOURCE/commits?sha=$BRANCH&since=$since")

          # å¦‚æœè¿”å›é‡ŒåŒ…å« "sha" å­—æ®µï¼Œå°±è¡¨ç¤ºæœ‰æäº¤
          if echo "$resp" | grep -q '"sha"'; then
            echo "Found new commits. Will build."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits in the last 24 hours. Skip build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  # ç¬¬äºŒæ­¥ï¼šå¦‚æœæœ‰æ›´æ–°ï¼Œå…ˆæ¸…ç†æ—§ Release/Workflowï¼ˆä¿ç•™ 2 ä¸ªæœ€æ–°çš„ï¼‰
  clean:
    needs: check_updates
    if: needs.check_updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Delete old Releases and Workflows
        uses: ophub/delete-releases-workflows@main
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          delete_releases: true
          releases_keep_latest: 2   # â­ åªä¿ç•™æœ€æ–° 2 ä¸ª Release
          delete_tags: true
          delete_workflows: true
          workflows_keep_day: 0

  # ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæœ‰æ›´æ–°ï¼Œå†è§¦å‘ AXT1800.yml æ‰§è¡Œæ­£å¼ç¼–è¯‘
  trigger_build:
    needs: clean
    if: needs.check_updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch AXT1800 workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering AXT1800 workflow_dispatch..."

          curl -s -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/AXT1800.yml/dispatches \
            -d '{"ref":"main","inputs":{"PACKAGE":"","TEST":"false"}}'

